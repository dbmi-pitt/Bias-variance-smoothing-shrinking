---
title: "Bias, variance, smoothing, and shrinking"
output: 
  html_document:
    css: lumpsplit.css
runtime: shiny
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
options(knitr.duplicate.label = 'allow')
#options(error=browser)
require(T15lumpsplit)
```

```{r setup numbering, warning=FALSE}
try(rm(envNextNumber, pos=1), silent = TRUE)
try(rm(envNextNumberTOC, pos=1), silent = TRUE)
try(rm(envNextNumberQA, pos=1), silent = TRUE)
try(rm(envNextNumberTextQuestion, pos=1), silent = TRUE)
### Note that the .GlobalEnv seen here is different from your R session... and it persists across Rmd runs!
source('nextNumber.R', local=TRUE)
source('interactiveSection.R', local=TRUE)
source('QandAha.R', local=TRUE)
source('TextQuestion.R', local=TRUE)
```


```{r includeFunctions}
source('inclRmd.R', local=T)
source('linkout.R', local=T)
source('interactiveSection.R', local=T)
source('includeHTMLtrimmed.R', local=T)

```


```{r initial values, echo=FALSE}

logit = function(p) log(p/(1-p))
antilogit = function(x) 1 - 1/(1+exp(x))
DLdata = matrix(c(3,5,2,90),nrow=2)
dimnames(DLdata) = list(c("D","L"),c("R","N"))
ColorForPrior="orange";     
ColorForPosterior="blue";     
ColorForLikelihood="black"
TOCnum =  0
```

```{r navTOCid.R}
#source('navTOCid.R', local=T)
```


```{r servercode}
source("Plight-Pdark-posterior-new.R", local=TRUE)
rValues = reactiveValues(tau = 1,  phi = 0.001, mu=0.5,
                         title_1='title 1',
                         DLdata = DLdata)
```

```{r plotPlightPdarkPosteriorReactive}
plotPlightPdarkPosteriorReactive = reactive( {
  cat("PLOTTING   ")
  tau <- input$tauInput
  phi <- input$phiInput
  mu0 <- input$mu0Input
  cat("tau=", tau, " phi=", phi, " mu0=", mu0, "\n")
  plotPlightPdarkPosterior(DLdata=rValues$DLdata,
                           tau=tau, phi=phi, mu0=logit(mu0), 
                           showPrior = input$checkPrior, 
                           showPosterior = input$checkPosterior,
                           fudgeFactor = input$fudgeFactor)
  rValues$title_3 <<- paste0(
    "  tau=", input$tauInput,  
    ",  phi=", input$phiInput,  
    ",  mu0=", input$mu0Input 
  )
})
```


```{r lumpReact}
lumpReact = observe({
  if(length(input$lumpID) > 0) {
    cat("lumpID\n")
    rValues$tau <- 1; rValues$phi <- 0.001   
    ### Lump:  no individual variation:   D is same as L.
    rValues$title_1 <- "Lump"
    rValues$title_2 <- "Prior belief: Pr(R|D) = Pr(R|L)"
  }
})  
```

```{r updateDLdata}
updateDLdata = observe({
  try(silent = TRUE, {
    rValues$DLdata[1,1] = input$mRD
    rValues$DLdata[1,2] = input$mND
    rValues$DLdata[2,1] = input$mRL
    rValues$DLdata[2,2] = input$mNL
  })
  cat('input$mRD', input$mRD, '\n')
})
```

```{r splitReact}
splitReact = observe({
  if(length(input$splitID) > 0) {
    cat("splitID\n")
    rValues$tau <<- 0; rValues$phi <<- 1   
    ### Split:  D unconnected to L.
    rValues$title_1 <<- "Split"
    rValues$title_2 <<- "Prior belief: Pr(R|D) is unrelated to Pr(R|L)."
  }
}) 
```

```{r mixedReact} 
mixedReact = observe({
  if(length(input$mixedID) > 0) {
    cat("mixedID\n")
    rValues$tau <<- 1/2; rValues$phi <<- 1/2 
    rValues$title_1 <<- "Compromise: lump some, split some"
    rValues$title_2 <<- "Prior belief:  Pr(R|D)  is somewhat related to Pr(R|L). "
  }
})
```

```{r updateViews}
updateViews = observe({
  updateNumericInput(session=session, inputId="tauInput", 
                     value = rValues$tau)
  updateNumericInput(session=session, inputId="phiInput", 
                     value = rValues$phi)
})
```


```{r thePlot}
output$title_1_ID = renderText({rValues$title_1})
output$title_2_ID = renderText({rValues$title_2})
output$title_3_ID = renderText({rValues$title_3})

output$thePlot = renderPlot(width=500, height=500,
                            {
                              par(mai=c(1.4,1.4,1.1,0.6))
                              par(mar=c(5,5,4,2) + 0.2)
                              plotPlightPdarkPosteriorReactive()
                            })
```

```{r makeDebuggingPanelOutput}
shinyDebuggingPanel::makeDebuggingPanelOutput(
  session, toolsInitialState = FALSE) 
```


```{r navTOCid.R.2}
#source('navTOCid.R', local=T)
```

```{r withDebuggingPanel}
##  <a name='debugging'>** **</a>
fluidRow(
  shinyDebuggingPanel::withDebuggingPanel() 
)
```

```{r}
# navTOCid = paste0('navTOC',TOCnum); TOCnum = TOCnum+1
# output[[navTOCid]] <- renderUI({ tagList(inclRmd("navTOC.Rmd") )})
# conditionalPanel('false', uiOutput(navTOCid))
#source('navTOCid.R', local=T)

```


```{r}
##source('navTOCid.R', local=T)
```

```{r panelOfInputs}
panelOfInputs = 
  wellPanel(strong(em("Declaring the Prior Distribution ")),
    checkboxInput(inputId= 'togglePanelOfInputs', 
                  label = 'togglePanelOfInputs',value = TRUE),
    conditionalPanel(
      "input.togglePanelOfInputs",
      wellPanel(
        numericInput("phiInput", "prior variance | group (phi)", 
                     value=0, min = 0.00, step=0.1),
        numericInput("tauInput", "shared additional variance (tau)", 
                     value=1, min = 0.00, step=0.1),
        numericInput("mu0Input", "shared prior mean", 
                     value=0.5, min = 0.001, step=0.1, max=0.999),
        actionButton("lumpID", label = "Lump"),
        actionButton("splitID", label = "Split"),
        actionButton("mixedID", label = "Mixed")
      ),
      numericInput(inputId = 'fudgeFactor', 
                   label = 'continuity fudge factor',
                   value=0.001)
    ))
```


```{r show-hide-contours}
ContoursPanelLegend = list(
  div(style="color:orange", 
      checkboxInput("checkPrior", 
                    "Orange = prior distribution",
                    TRUE)),
  div(style="color:blue",
      checkboxInput("checkPosterior", 
                    "Blue = posterior distribution",
                    TRUE)),
  "Shaded: 50% highest posterior region"
)
```

```{r responseRates}
output$responseRates = renderText({
  paste(input$mRD, '/', input$mRD+input$mND, "for D, and ",
        input$mRL, '/', input$mRL+input$mNL, "for L.")
})

panelOfData = wellPanel(
  strong(em("Data: Response by Predictor")),
  checkboxInput('toggleShowData', 'Show/Hide the Data Panel', FALSE),
  conditionalPanel(
    'input.toggleShowData',
    wellPanel(
      splitLayout("", "Responders", "non-responders"),
      splitLayout("Group 'L'",
                  numericInput('mRL', 'mRL', DLdata[2,1]),
                  numericInput('mNL', 'mNL', DLdata[2,2])
      ),
      splitLayout( "Group 'D'",
                   numericInput('mRD', 'mRD', DLdata[1,1]),
                   numericInput('mND', 'mND', DLdata[1,2])
      ), 
      "X = observed response rate, ",
      br(),
      textOutput(outputId = 'responseRates'),
      hr()
    )
  )
)
```

```{r panelOfBifurcation}
panelOfBifurcation = wellPanel(
  strong(em("Bifurcated analysis: P>0.05? then lump. P<0.05? then split")),
  checkboxInput('toggleShowFisher', 'Show/Hide the Fisher test', FALSE)
)
  
```



```{r UI_begins}
#### UI fluidPage####
require(shinyBS)
#inclRmd('Overview.Rmd')
# You can only use inclRmd once; otherwise "duplicate label 'unnamed-chunk-1"
#out = knitr::knit_child('Overview.Rmd', quiet=TRUE)
#markdown::markdownToHTML(text = out)
```

```{r Overview}
inclRmd('Overview.Rmd')
```

```{r overviewTOC_dup}
#source('navTOCid.R', local=T)
TOCnum = nextNumber(sequenceType="TOC")
navTOCid = paste0('navTOC',TOCnum);
#cat('navTOCid', navTOCid, '\n')
cbInputId = paste0('cbInputId', navTOCid)
cbInputJS = paste0('input.',cbInputId)
output[['navTOCid']] <- renderUI({
  list(checkboxInput(cbInputId, "show/hide outline of topics", value=FALSE),
       conditionalPanel(condition = cbInputJS,
                        tagList(inclRmd("navTOC.Rmd")) )
  )
})
uiOutput('navTOCid')
```




```{r include notebook}
div(list(fluidRow(
  column(width = 8, 
         wellPanel(id = "leftScrollPanel",
                   style = "overflow-y:scroll; max-height: 600px"
         , inclRmd('LumpSplit-with-notebook-Notebook.Rmd')
         )),
  column(width = 4, panelOfData,
         panelOfBifurcation,
                    panelOfInputs,
                  ContoursPanelLegend,
                  br(),
                  tagAppendAttributes(
                    div(
                      textOutput(outputId="title_1_ID"),
                      textOutput(outputId="title_2_ID"),
                      textOutput(outputId="title_3_ID")
                    ),
                    style=
                      'text-align:center; font-size:large; font-weight:bold'),
                  a(name='viewPlot'),
                  plotOutput(outputId = 'thePlot')
                )
)
))
```

```{r}
div(list(br(),br(),br(),br(),br(),br(),br(),br()))
```
```{r include navTOCid}
#source('navTOCid.R', local=T)
```
```{r}
div(list(br(),br(),br(),br()))
```



